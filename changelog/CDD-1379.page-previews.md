# CDD-1379 - Page Previews

Jira: https://ukhsa.atlassian.net/browse/CDD-1379?search_id=055fe61d-bee9-48d9-80bc-ffb0f1c26b76&referrer=quick-find

## Summary

Allow editors of headless composite pages to click a **Preview** button
that immediately redirects them to the external frontend application, rather
than opening the built-in Wagtail iframe preview.  Preview URLs include a
short-lived signed token so the frontend can safely fetch draft content from
the CMS.

## Implementation details

1. **CompositePage.is_previewable**
   * Previously returned `False` (comment/documentation mismatch); tests and
     runtime behaviour also assumed preview wasn’t available.  Set back to
     `True` so Wagtail renders preview-related UI.

2. **Admin hooks & redirect view**
   * Added `PreviewToFrontendRedirectView` in `cms/dashboard/views.py`.
     - builds a payload (slug, editor id, iat, exp)
     - signs with `django.core.signing.dumps(..., salt="preview-token")`
     - redirects to `https://example.com?page=<slug>&draft=true&t=<token>`
   * Registered the view under `cms_preview_to_frontend` via
     `register_admin_urls` hook.
   * Wagtail hook `register_page_header_buttons` returns a `Button` that
     points at the admin redirect URL (with fallback) when `view_name ==
     "edit"`.
   * Added `construct_page_action_menu` hook inserting a custom
     `ActionMenuItem` as the primary action, ensuring the preview button is
     visible in the page editor header.

3. **Suppressing the preview panel**
   * Monkey-patched `EditView.get_side_panels` at import time in
     `cms/dashboard/wagtail_hooks.py`.
   * Patch filters out any `PreviewSidePanel` instance when the page being
     edited is a `CompositePage` (or subclass), preventing the iframe panel
     from being constructed.
   * Added comprehensive unit tests verifying the patch behaviour without
     hitting the database.

4. **Tests**
   * Added a comprehensive suite of unit tests covering every change:
     - `frontend_preview_button` returns a `Button` in edit mode and falls
       back to the template URL when reverse fails.
     - Redirect view permissions, success path, and URL tokenization logic.
     - `add_frontend_preview_action` handles missing/PK-less pages, reverse
       failures, and even exceptions during menu insertion.
     - Monkey‑patched `EditView.get_side_panels` strips the preview panel and
       gracefully handles errors during filtering.
     - `_add_page_to_parent` behaviour tested, including raising
       `ValueError` when passed `None`.
   * Tests are written to avoid any database access where possible by using
     fakes and sentinels; only a single integration test touches the DB.
   * The two modified modules (`wagtail_hooks.py` and
     `build_cms_site_helpers/pages.py`) are fully exercised by the new tests.

5. **Documentation & comments**
   * Added explanatory comments throughout hooks file explaining rationale
     and behaviour.
   * Adjusted `CompositePage.is_previewable` docstring to explain why it's
     `True` now and how the panel is suppressed separately.

6. **Frontend workflow notes** (documented in discussion but not coded):
   * Frontend receives slug & signed token, sends them to a preview API
     endpoint which verifies the token with the CMS secret, looks up the
     page by slug, and returns JSON representing the page’s content.
   * The slug is the same key used by normal frontend routing; no reverse
     mapping is required.
   * Token verification happens entirely on the backend; the frontend never
     needs the secret.

## Why

The service is headless; embedding the CMS iframe preview is inappropriate
and results in missing-template errors.  Editors still need a convenient way
to view draft pages in context, so we intercept the preview flow, keep the
preview button, and redirect to the external Next.js application with an
HMAC token.  This approach preserves Wagtail’s preview plumbing (e.g. the
`is_previewable` flag and button hooks) while avoiding the iframe and
making preview links easy to secure and consume.

---

See also:
* [tests/unit/cms/dashboard/test_wagtail_hooks.py](../tests/unit/cms/dashboard/test_wagtail_hooks.py)
* [cms/dashboard/wagtail_hooks.py](../cms/dashboard/wagtail_hooks.py)
* [cms/dashboard/views.py](../cms/dashboard/views.py)
* [cms/composite/models.py](../cms/composite/models.py)
